<!-- ONLY CHANGE DONE: API_URL FIXED -->
<script>
/* ================= IMPORTANT CHANGE ================= */
const API_URL = "http://13.250.103.101:30007/api";
/* ==================================================== */

let inventory = [];
let sales = [];
let cart = [];
let isConnected = false;

// Check connection
async function checkConnection() {
    try {
        const response = await fetch(`${API_URL}/products`);
        if (response.ok) {
            updateConnectionStatus(true);
            return true;
        } else {
            updateConnectionStatus(false);
            return false;
        }
    } catch (error) {
        updateConnectionStatus(false);
        return false;
    }
}

function updateConnectionStatus(connected) {
    isConnected = connected;
    const statusDiv = document.getElementById('connectionStatus');
    const statusText = document.getElementById('statusText');
    
    if (connected) {
        statusDiv.className = 'connection-status status-connected';
        statusText.textContent = '✓ Connected to Server';
    } else {
        statusDiv.className = 'connection-status status-disconnected';
        statusText.textContent = '✗ Server Offline';
    }
}

// Load products
async function loadProducts() {
    try {
        const response = await fetch(`${API_URL}/products`);
        if (response.ok) {
            inventory = await response.json();
            updateUI();
        }
    } catch (error) {
        console.log(error);
    }
}

// Load sales
async function loadSales() {
    try {
        const response = await fetch(`${API_URL}/sales`);
        if (response.ok) {
            sales = await response.json();
            updateUI();
        }
    } catch (error) {
        console.log(error);
    }
}

// Load stats
async function loadStats() {
    try {
        const response = await fetch(`${API_URL}/stats`);
        if (response.ok) {
            const stats = await response.json();
            document.getElementById('totalRevenue').textContent = stats.revenue.toFixed(2);
            document.getElementById('totalProfit').textContent = stats.profit.toFixed(2);
            document.getElementById('totalSales').textContent = stats.sales_count;
            document.getElementById('totalProducts').textContent = stats.total_products;
            document.getElementById('lowStockCount').textContent = stats.low_stock_count;
        }
    } catch (error) {
        console.log(error);
    }
}

// Add product
async function addProduct() {
    const name = document.getElementById('productName').value.trim();
    const category = document.getElementById('productCategory').value;
    const barcode = document.getElementById('productBarcode').value.trim();
    const cost = parseFloat(document.getElementById('productCost').value);
    const price = parseFloat(document.getElementById('productPrice').value);
    const stock = parseInt(document.getElementById('productStock').value);
    const min_stock = parseInt(document.getElementById('productMinStock').value) || 5;

    if (!name || !cost || !price || !stock) {
        alert("Fill all fields");
        return;
    }

    await fetch(`${API_URL}/products`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({name,category,barcode,cost,price,stock,min_stock})
    });

    loadProducts();
}

// Delete product
async function deleteProduct(id){
    await fetch(`${API_URL}/products/${id}`,{method:'DELETE'});
    loadProducts();
}

// Update stock
async function updateStock(id){
    const qty = prompt("Enter new stock:");
    if(!qty) return;

    await fetch(`${API_URL}/products/${id}`,{
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({stock:parseInt(qty)})
    });
    loadProducts();
}

// Complete sale
async function completeSale(){
    if(cart.length===0){alert("Cart empty");return;}

    const res = await fetch(`${API_URL}/sales`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({items:cart})
    });

    if(res.ok){
        alert("Sale done");
        cart=[];
        loadProducts();
        loadSales();
    }
}

// Chatbot
async function sendChatMessage(){
    const input=document.getElementById('chatbotInput');
    const msg=input.value;
    if(!msg) return;

    const res=await fetch(`${API_URL}/chatbot`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({message:msg})
    });

    const data=await res.json();
    alert(data.response);
}

// INIT
async function initApp(){
    const ok=await checkConnection();
    if(ok){
        loadProducts();
        loadSales();
        loadStats();
    }else{
        alert("Server not connected");
    }
}

window.onload=initApp;
</script>
